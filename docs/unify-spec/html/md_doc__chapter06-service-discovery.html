<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Unify Specification: Service Discovery</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Unify Specification
   &#160;<span id="projectnumber">ver1_0_RC11_20211006-19-g32c28c7</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Service Discovery </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md118"></a>
Concept</h1>
<p>All MQTT Clients (possibly including Protocol Controllers) must be able to find out the existing devices and their capabilities to provide functionalities. Using MQTT subscriptions as a service discovery, each client can receive information about what they are interested in given that they have a starting point.</p>
<h2><a class="anchor" id="autotoc_md119"></a>
MQTT Topics</h2>
<p>Some high-level functionalities will be expected to be present at the MQTT broker from the beginning, as follows:</p>
<ul>
<li>ucl/by-unid/#</li>
<li>ucl/by-group/#</li>
</ul>
<p>More than this can be appended to the initial list in future versions. An MQTT client MAY subscribe to the 'ucl/#' topic filter and get all published messages by the MQTT broker. However, this is not optimal from a traffic point of view. MQTT Clients SHOULD subscribe to the minimum they need, while still ensuring that they do not miss anything.</p>
<p>The minimum requirement to discover nodes and their capabilities is a single subscription to <em>ucl/by-unid/#</em>. If the resources are available, the discovery will happen via the publication of new MQTT messages, which will show that devices have been added to the network and their associated capabilities.</p>
<h2><a class="anchor" id="autotoc_md120"></a>
Discovery of the Protocol Controllers</h2>
<p>Protocol Controllers will start by advertising themselves as a resource by publishing to <em>ucl/by-unid/&lt;their-unid&gt;/ProtocolController/NetworkManagement</em>. They will be able to issue a payload indicating their current network management state and what they can do to set up a network. For more details, see <a class="el" href="md_doc__chapter03-network-management.html">Network Management</a>.</p>
<p>An IoT Service can therefore find out more about Protocol Controllers in general by subscribing to <em>ucl/by-unid/+/ProtocolController/+</em>.</p>
<h2><a class="anchor" id="autotoc_md121"></a>
Discovery Done by Protocol Controllers</h2>
<p>The Protocol Controllers are devices that are capable to add/remove devices in their PAN and therefore publish about their identity and capabilities. For example, after a network inclusion, a Protocol Controller will perform the necessary node interview, which will allow it to publish about the newly added PAN node. It is expected that the Protocol Controller assign a unique identifier to the node and start by publishing using the assigned UNID.</p>
<p>All nodes will have a generic state topic, where general information is published about the node. The topic is <em>ucl/by-unid/&lt;unid&gt;/State</em>.</p>
<p>The state topic is a JSON object that MUST follow the following JSON Schema.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;$schema&quot;: &quot;http://json-schema.org/draft-07/schema#&quot;,</div>
<div class="line">  &quot;title&quot;: &quot;UNID State&quot;,</div>
<div class="line">  &quot;description&quot;: &quot;State of a PAN Node&quot;,</div>
<div class="line">  &quot;type&quot;: &quot;object&quot;,</div>
<div class="line">  &quot;properties&quot;: {</div>
<div class="line">    &quot;NetworkStatus&quot;: {</div>
<div class="line">      &quot;type&quot;: &quot;string&quot;,</div>
<div class="line">      &quot;enum&quot;: [</div>
<div class="line">        &quot;Online functional&quot;,</div>
<div class="line">        &quot;Online interviewing&quot;,</div>
<div class="line">        &quot;Online non-functional&quot;,</div>
<div class="line">        &quot;Unavailable&quot;,</div>
<div class="line">        &quot;Offline&quot;</div>
<div class="line">      ]</div>
<div class="line">    },</div>
<div class="line">    &quot;Security&quot;: {</div>
<div class="line">      &quot;type&quot;: &quot;string&quot;,</div>
<div class="line">      &quot;enum&quot;: [</div>
<div class="line">        &quot;None&quot;,</div>
<div class="line">        &quot;Z-Wave S0&quot;,</div>
<div class="line">        &quot;Z-Wave S2 Unauthenticated&quot;,</div>
<div class="line">        &quot;Z-Wave S2 Authenticated&quot;,</div>
<div class="line">        &quot;Z-Wave S2 Access Control&quot;,</div>
<div class="line">        &quot;Zigbee Z3&quot;</div>
<div class="line">      ]</div>
<div class="line">    },</div>
<div class="line">    &quot;MaximumCommandDelay&quot;: {</div>
<div class="line">      &quot;type&quot;: [</div>
<div class="line">        &quot;number&quot;,</div>
<div class="line">        &quot;string&quot;</div>
<div class="line">      ],</div>
<div class="line">      &quot;pattern&quot;: &quot;^(unknown)|(infinite)$&quot;</div>
<div class="line">    }</div>
<div class="line">  },</div>
<div class="line">  &quot;required&quot;: [</div>
<div class="line">    &quot;NetworkStatus&quot;,</div>
<div class="line">    &quot;Security&quot;,</div>
<div class="line">    &quot;MaximumCommandDelay&quot;</div>
<div class="line">  ]</div>
<div class="line">}</div>
</div><!-- fragment --><p>The properties in the JSON object of the state topic is shown below:</p>
<table class="doxtable">
<caption>MQTT topic properties for nodes general state information</caption>
<tr>
<th>Property name </th><th>Description </th><th>Example value  </th></tr>
<tr>
<td>NetworkStatus </td><td>Indicated if the node is part of the network or available in general. This should include intermediate states to give progress feedback during inclusion. More details about each value is provided in the NetworkStatus subsection </td><td>"Online functional"<br  />
"Online interviewing"<br  />
"Online non-functional"<br  />
"Unavailable"<br  />
"Offline"  </td></tr>
<tr>
<td>Security </td><td>Indicates if the node uses encryption for communication on the PAN </td><td>"Z-Wave S2 Authenticated"  </td></tr>
<tr>
<td>MaximumCommandDelay </td><td>Indicates the maximum delay that it can take to deliver a command to the node, in seconds It can either be deterministic (with a precise value), "unknown", or "infinite". It can therefore either be a JSON number or JSON String. </td><td>4200<br  />
"unknown"<br  />
"infinite"  </td></tr>
</table>
<p>So for example, when a new node joined the network and interview/setup is completed, the Protocol Controller MUST publish:</p>
<blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/984540640/State</em><br  />
 Payload:<br  />
 </p><div class="fragment"><div class="line">{</div>
<div class="line">  &quot;NetworkStatus&quot;: &quot;Online functional&quot;,</div>
<div class="line">  &quot;Security&quot;: &quot;Z-Wave S0&quot;,</div>
<div class="line">  &quot;MaximumCommandDelay&quot;: 4200</div>
<div class="line">}</div>
</div><!-- fragment --><p></p>
</blockquote>
<p>This will indicate that the node is now operational. It has been securely included using maximum requested security. For a Wake Up / sleeping device, there may be a delay before a given command is issued to the node before a publish back confirms that the application state has changed. For always listening/reachable nodes, "MaximumCommandDelay" can be set to 0.</p>
<p>A Protocol Controller managing several networks with separate network IDs may expose the network IDs as an optional parameter in the State topic. The UNIDs assigned to nodes from each network must be unique.</p>
<p>The network state is shared for all endpoints of a PAN node.</p>
<p>However, an IoT Service still does not know what the node's capabilities are. The Protocol Controller is in charge of figuring it out and publish on topics representing the Endpoints and their ZigBee server clusters. After they are discovered, the Protocol Controller MUST publish in a sub-topic under the node's unid/endpoint the supported commands and attributes state of a given cluster.</p>
<blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/+/+/&lt;ClusterName&gt;/Attributes/&lt;AttributeName&gt;/Reported</em><br  />
 Topic: <em>ucl/by-unid/+/+/&lt;ClusterName&gt;/Attributes/&lt;AttributeName&gt;/Desired</em><br  />
 Topic: <em>ucl/by-unid/+/+/&lt;ClusterName&gt;/SupportedCommands</em><br  />
 </p>
</blockquote>
<p>It means that when a new node joined the network and interview/setup is completed, the Protocol Controller figures out the list of supported attributes, their values, and the list of supported commands that it publishes back under each endpoint. For example, for a multi-endpoint dimming node (not including all mandatory attributes here for readability:</p>
<blockquote class="doxtable">
<ol type="1">
<li>Publish <blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/zw-1234/ep0/OnOff/Attributes/OnOff/Desired</em><br  />
 Payload: <code>{ "value" : true }</code> </p>
</blockquote>
</li>
<li>Publish <blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/zw-1234/ep0/OnOff/Attributes/OnOff/Reported</em><br  />
 Payload: <code>{ "value" : true }</code> </p>
</blockquote>
</li>
<li>Publish <blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/zw-1234/ep0/OnOff/SupportedCommands</em><br  />
 Payload: <code>{ "value" : [ "On", "Off", "Toggle", "WriteAttributes"]}</code> </p>
</blockquote>
</li>
<li>Publish <blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/zw-1234/ep1/OnOff/Attributes/OnOff/Desired</em><br  />
 Payload: <code>{ "value" : false }</code> </p>
</blockquote>
</li>
<li>Publish <blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/zw-1234/ep1/OnOff/Attributes/OnOff/Reported</em><br  />
 Payload: <code>{ "value" : true }</code> </p>
</blockquote>
</li>
<li>Publish <blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/zw-1234/ep1/OnOff/SupportedCommands</em><br  />
 Payload: <code>{ "value" : [ "On", "Off", "Toggle", "WriteAttributes"]}</code> </p>
</blockquote>
</li>
<li>Publish <blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/zw-1234/ep2/Level/Attributes/CurrentLevel/Desired</em><br  />
 Payload: <code>{ "value" : 100 }</code> </p>
</blockquote>
</li>
<li>Publish <blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/zw-1234/ep2/Level/Attributes/OnOff/Reported</em><br  />
 Payload: <code>{ "value" : 100 }</code> </p>
</blockquote>
</li>
<li>Publish <blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/zw-1234/ep2/OnOff/SupportedCommands</em><br  />
 Payload: <code>{ "value" :[ "MoveToLevel", "Move", "Step", "Stop", "WriteAttributes"]}</code> </p>
</blockquote>
</li>
</ol>
</blockquote>
<p>To fit into the proper MQTT topic hierarchy, commands names are stripped from their "/" and whitespace characters.</p>
<p>To receive the supported commands (used by IoT Service to control end nodes), the Protocol Controller will subscribe to the topics according to what the node capabilities are, so that it can receive the commands from other MQTT clients:</p>
<blockquote class="doxtable">
<p>subscribe: <em>ucl/by-unid/984540640/ep0/OnOff/Commands/WriteAttributes</em><br  />
 subscribe: <em>ucl/by-unid/984540640/ep0/OnOff/Commands/On</em><br  />
 subscribe: <em>ucl/by-unid/984540640/ep0/OnOff/Commands/Off</em><br  />
 subscribe: <em>ucl/by-unid/984540640/ep0/OnOff/Commands/Toggle</em><br  />
 subscribe: <em>ucl/by-unid/984540640/ep0/Level/Commands/WriteAttributes</em><br  />
 subscribe: <em>ucl/by-unid/984540640/ep0/Level/Commands/MoveToLevel</em><br  />
 etc. Alternatively, subscribe to the topic filters: subscribe: <em>ucl/by-unid/984540640/ep0/OnOff/Commands/+</em><br  />
 subscribe: <em>ucl/by-unid/984540640/ep0/Level/Commands/+</em><br  />
 </p>
</blockquote>
<p>The following generic command will always be available for all clusters.</p>
<blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/+/+/&lt;ClusterName&gt;/Commands/WriteAttributes</em><br  />
 Payload: </p><div class="fragment"><div class="line">{</div>
<div class="line">  &quot;AttributeName1&quot;: &quot;AttributeValue1&quot;,</div>
<div class="line">  &quot;AttributeName2&quot;: &quot;AttributeValue2&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><p></p>
</blockquote>
<p>If none of the attributes in a cluster are writable (i.e., they are all read-only), this command will not have any effect.</p>
<p>Commands that cannot be translated by the Protocol Controller translator module (e.g., Z-Wave Commands that are not translated into any ZigBee Cluster) will not be advertised as capabilities as it is required that the commands are translated correctly before delivery to the end node.</p>
<p>Commands will be mapped as topics under each cluster. When an MQTT Client issues a command that will modify one or more attributes in a cluster, the Protocol Controller will publish back the list of attributes and their values after it made sure that the attributes values were correctly changed. For protocols like Z-Wave, it will include the translator to add Supervision Encapsulation or issue a subsequent Get Command in order to verify the state/value of each attribute.</p>
<h3><a class="anchor" id="autotoc_md122"></a>
NetworkStatus</h3>
<p>The NetworkStatus property of the UNID state topic JSON object can take the following values.</p>
<table class="doxtable">
<caption>NetworkStatus property value</caption>
<tr>
<th>Value </th><th>Description  </th></tr>
<tr>
<td>"Online interviewing" </td><td>The node has joined the network but it is not ready to be operational yet because an initial setup and interview need to be done before it can be controlled.  </td></tr>
<tr>
<td>"Online functional" </td><td>The node has joined the network, all required setup is functional, and the node capabilities are known. IoT Services can fully operate the node.  </td></tr>
<tr>
<td>"Online non-functional" </td><td>The node has joined the network and the Protocol Controller can communicate with it, but important setup failed and therefore its capabilities may be degraded. It can nonetheless be controlled, but fewer capabilities than expected may be exposed.  </td></tr>
<tr>
<td>"Unavailable" </td><td>The node has joined the network and is most likely "Online functional" but the Protocol Controller cannot service any command or state information at the moment. This can happen, for example if the Protocol Controller reboots or is offline.  </td></tr>
<tr>
<td>"Offline" </td><td>The node has joined the network but cannot be reached by the Protocol Controller within expected delays. The node has a connectivity issue.  </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md123"></a>
List of endpoints available for nodes</h2>
<p>Protocol Controller SHOULD advertise the list of available endpoints for a given node and themselves under the topics:</p>
<ul>
<li><b>ucl/by-unid/&lt;unid&gt;/State/Attributes/EndpointIdList/Reported</b></li>
<li><b>ucl/by-unid/&lt;unid&gt;/State/Attributes/EndpointIdList/Desired</b></li>
</ul>
<p>IoT Services cannot assume that the Endpoint ID list will always be available.</p>
<p>IoT Services can also deduce Endpoints ID based on publications made to the application clusters for a each endpoint.</p>
<h1><a class="anchor" id="autotoc_md124"></a>
MQTT Client Controlling Examples</h1>
<h2><a class="anchor" id="autotoc_md125"></a>
OnOff Cluster Control</h2>
<p>An IoT Service interested only in OnOff Cluster control will subscribe to the following two topic filters:</p><ul>
<li><em>ucl/by-unid/+/+/OnOff/Attributes/#</em>.</li>
<li><em>ucl/by-unid/+/+/OnOff/SupportedCommands</em>.</li>
</ul>
<p>When an IoT Service receives publish messages, such as <em>ucl/by-unid/98146584/ep10/OnOff/SupportedCommands</em>, it will then know that a Protocol Controller can service commands for the the OnOff Cluster for unid 98146584, endpoint 10. The MQTT Client can issue the cluster commands (e.g On) to the corresponding subtopic: <em>ucl/by-unid/98146584/ep10/OnOff/Commands/On</em>.</p>
<p>When an IoT Service publishes a command such as <em>ucl/by-unid/98146584/ep10/OnOff/Commands/On</em>, the Protocol Controller will translate the command to one or more commands specific to its PHY to achieve the desired effect. When the operation is completed, the Protocol Controller will publish the updated state of the attributes for the cluster server. In other words, attributes updates within the OnOff Cluster can be used as a confirmation that the command was executed (or not) and also to tell other MQTT clients that the state of the end device has changed.</p>
<p>For example: </p><blockquote class="doxtable">
<p>Publish Topic: <em>ucl/by-unid/98146584/ep10/OnOff/Attributes/On/Reported</em><br  />
 Payload: <code>{"value": true}</code> </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md126"></a>
Delay in Command Execution</h2>
<p>If an IoT Service wants to display accurate state information, it needs to subscribe to the <em>ucl/by-unid/+/State</em> topic. This topic contains information that may affect the way they can expect to interact with the end device, such as the <em>MaximumCommandDelay</em> parameter. This value indicates how long they have to expect a publish message back showing the effect of their command in the worst case.</p>
<p>The Maximum Command Delay is identical for all endpoints under an UNID. If a Protocol Controller has several endpoints that have a different response delay, this value MUST advertise the worst case scenario.</p>
<p>Every time a desired state or reported state is updated for a given end node, the Protocol Controller servicing the end node will publish on the State topic. For example:</p>
<blockquote class="doxtable">
<ol type="1">
<li>MQTT Client Publishes <blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/98146584/ep10/OnOff/Commands/On</em><br  />
 Payload: <code>{ }</code> </p>
</blockquote>
</li>
<li>The servicing Protocol Controller acknowledges the request and publishes: <blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/98146584/ep10/OnOff/Attributes/On/Desired</em><br  />
 Payload: <code>{ "value": true }</code> </p>
</blockquote>
</li>
<li>When the protocol controller has confirmed that the OnOff device is turned on, it publishes again the state information: <blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/98146584/ep10/OnOff/Attributes/On/Reported</em><br  />
 Payload: <code>{ "value": true }</code> </p>
</blockquote>
</li>
</ol>
</blockquote>
<p>A more detailed example of this mechanism is shown in the diagrams in <a class="el" href="md_doc__chapter02-_z_c_l-in-uic.html">Chapter 2 - ZCL in Unify</a>.</p>
<h2><a class="anchor" id="autotoc_md127"></a>
Unresponsive Node</h2>
<p>A Protocol Controller will publish using the node state topic when it finds out that a node is failing and may have left the network. It may not constantly monitor nodes' link and it may figure out an unexpected delay when an MQTT Client publishes to the following:</p>
<blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/984540640/ep3/Identify/Commands/Identify</em><br  />
 Payload: <code>{ "IdentifyTime":"0x003C" }</code> </p>
</blockquote>
<p>The Protocol Controller will try to issue the commands and realize that the node is not responsive. In this case, the Protocol Controller will also publish back on the node state (instead of usually the cluster state).</p>
<blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/984540640/State</em><br  />
 Payload: </p><div class="fragment"><div class="line">{</div>
<div class="line">  &quot;NetworkStatus&quot;: &quot;Offline&quot;,</div>
<div class="line">  &quot;Security&quot;: &quot;Bluetooth passkey&quot;,</div>
<div class="line">  &quot;MaximumCommandDelay&quot;: 0</div>
<div class="line">}</div>
</div><!-- fragment --><p></p>
</blockquote>
<p>If the Protocol Controller needs to advertise that a PAN node is no longer part of the network, it MUST publish a zero byte payload with retain flag = 1 at the state and all cluster subtopics belonging to the node:</p>
<blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/984540640/ep0/OnOff/Attributes/OnOff/Reported</em> - No payload<br  />
 Topic: <em>ucl/by-unid/984540640/ep0/OnOff/Attributes/OnOff/Desired</em> - No payload<br  />
 Topic: <em>ucl/by-unid/984540640/ep0/OnOff/SupportedCommands</em> - No payload<br  />
 Topic: <em>ucl/by-unid/984540640/ep0/Level/Attributes/CurrentLevel/Reported</em> - No payload<br  />
 Topic: <em>ucl/by-unid/984540640/ep0/Level/Attributes/CurrentLevel/Desired</em> - No payload<br  />
 Topic: <em>ucl/by-unid/984540640/ep0/Level/SupportedCommands</em> - No payload<br  />
 Topic: <em>ucl/by-unid/984540640/ep1/OnOff/Attributes/OnOff/Reported</em> - No payload<br  />
 Topic: <em>ucl/by-unid/984540640/ep1/OnOff/Attributes/OnOff/Desired</em> - No payload<br  />
 Topic: <em>ucl/by-unid/984540640/ep1/OnOff/SupportedCommands</em> - No payload<br  />
 Topic: <em>ucl/by-unid/984540640/ep1/Level/Attributes/CurrentLevel/Reported</em> - No payload<br  />
 Topic: <em>ucl/by-unid/984540640/ep1/Level/Attributes/CurrentLevel/Desired</em> - No payload<br  />
 Topic: <em>ucl/by-unid/984540640/ep1/Level/SupportedCommands</em> - No payload<br  />
 Topic: <em>ucl/by-unid/984540640/State</em> - No payload<br  />
 </p>
</blockquote>
<p>Doing this will allow MQTT clients to know that the resource is no longer available and SHOULD be deleted from their node list. Subsequent subscribers will not receive the retained cluster states and states because of the zero byte payload.</p>
<p>If a node has dynamic capabilities and a cluster server is removed, the same procedure must take place and the cluster Attribute and SupportedCommands topics MUST be published as an empty retained payload. In this case, the State topic will stay and the node MUST still be shown as available and operational by the MQTT clients.</p>
<h2><a class="anchor" id="autotoc_md128"></a>
Protocol Controller is Unable to Service PAN Nodes</h2>
<p>A Protocol Controller may be carrying operations that will restrict sending commands to the end devices. This could for example be rebooting or performing a firmware update. When this happens, the Protocol Controller MUST publish on the state of every UNID it can no longer service, for example if it has four nodes:</p>
<blockquote class="doxtable">
<ol type="1">
<li>Publish <blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/984540641/State</em><br  />
 Payload: </p><div class="fragment"><div class="line">{</div>
<div class="line">  &quot;NetworkStatus&quot; : &quot;Unavailable&quot;,</div>
<div class="line">  &quot;Security&quot; : &quot;Z-Wave S0&quot;,</div>
<div class="line">  &quot;MaximumCommandDelay&quot; : 4200</div>
<div class="line">}</div>
</div><!-- fragment --><p></p>
</blockquote>
</li>
<li>Publish <blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/984540642/State</em><br  />
 Payload: </p><div class="fragment"><div class="line">{</div>
<div class="line">  &quot;NetworkStatus&quot; : &quot;Unavailable&quot;,</div>
<div class="line">  &quot;Security&quot; : &quot;None&quot;,</div>
<div class="line">  &quot;MaximumCommandDelay&quot; : 0</div>
<div class="line">}</div>
</div><!-- fragment --><p></p>
</blockquote>
</li>
<li>Publish <blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/984540643/State</em><br  />
 Payload: </p><div class="fragment"><div class="line">{</div>
<div class="line">  &quot;NetworkStatus&quot; : &quot;Unavailable&quot;,</div>
<div class="line">  &quot;Security&quot; : &quot;Z-Wave S2 Authenticated&quot;,</div>
<div class="line">  &quot;MaximumCommandDelay&quot; : 0</div>
<div class="line">}</div>
</div><!-- fragment --><p></p>
</blockquote>
</li>
<li>Publish <blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/984540644/State</em><br  />
 Payload: </p><div class="fragment"><div class="line">{</div>
<div class="line">  &quot;NetworkStatus&quot; : &quot;Unavailable&quot;,</div>
<div class="line">  &quot;Security&quot; : &quot;Z-Wave S2 Access Control&quot;,</div>
<div class="line">  &quot;MaximumCommandDelay&quot; : 5</div>
<div class="line">}</div>
</div><!-- fragment --><p></p>
</blockquote>
</li>
</ol>
</blockquote>
<p>This status indicates that any publication made by MQTT clients for this PAN node will be ignored. MQTT Clients have to wait until the node is online again.</p>
<h1><a class="anchor" id="autotoc_md129"></a>
Group Discovery</h1>
<p>The MQTT Topic ucl/by-unid/# is the only one that provides a "per end device" granularity. The same end nodes will also be represented by conceptual groupings.</p>
<p>For example:</p>
<ul>
<li><em>ucl/by-location/Kitchen</em>: All devices in the kitchen</li>
<li><em>ucl/by-type/DoorLock</em>: All Door Lock devices</li>
<li><em>ucl/by-group/GroupID</em>: Some devices that the user has grouped together for simultaneous actuation</li>
</ul>
<h2><a class="anchor" id="autotoc_md130"></a>
By Location</h2>
<p>The location setting can be modified for each individual node using a dedicated cluster named NameAndLocation. This cluster contains two string attributes, "Name" and "Location". This data can be associated with a node, but it will be identical for each and every endpoint and it is not possible to set a different name and/or location to the different endpoints.</p>
<p>A ResourceDirectory MQTT Client will be in charge of aggregating and re-distributing this data. Protocol Controllers will not be aware of nodes names and location and will not use it for anything. The ResourceDirectory MQTT Client will listen to <em>ucl/by-unid/+/State</em> to get notifications of new nodes in the network. When a new node is added, it starts by assigning a default name a location, publish on a cluster for the node, and advertises it by publishing in the following two topics:</p>
<p>Example :</p>
<blockquote class="doxtable">
<p>MQTT Client publishes: </p><blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/984540640/NameAndLocation</em><br  />
 Payload: </p><div class="fragment"><div class="line">{</div>
<div class="line">  &quot;Name&quot;: &quot;node-984540640&quot;,</div>
<div class="line">  &quot;Location&quot;: &quot;Unknown location&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><p></p>
</blockquote>
<p>Resource Directory MQTT Client publishes back: </p><blockquote class="doxtable">
<p>Topic: <em>ucl/by-location/unknown_location/984540640</em><br  />
 Payload: <code>{ "unid":"984540640" }</code> </p>
</blockquote>
<p>The payload indicates that the node (unid:984540640) is available. </p>
</blockquote>
<p>Application MQTT Clients can write a new location for a node/endpoint by publishing for example:</p>
<blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/984540640/NameAndLocation/WriteAttributes</em><br  />
 Payload: </p><div class="fragment"><div class="line">{</div>
<div class="line">  &quot;Name&quot;: &quot;MySuperDoorLock&quot;,</div>
<div class="line">  &quot;Location&quot;: &quot;Entrance&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><p></p>
</blockquote>
<p>Application MQTT Clients can discover which devices are part of the location by subscribing to the <em>ucl/by-location/#</em> topic.</p>
<p>After a node is added in the network or the name and/or location is set for a node, the Resource Directory MQTT Client will publish back on both the <em>ucl/by-location/&lt;location&gt;/&lt;unid&gt;</em> with a dummy payload indicating that the node is live (e.g., <em>ucl/by-location/living_room/32049350</em> <code>{ "unid":"32049350" }</code>, and the clusters it serves on behalf on the node <em>ucl/by-unid/984540640/NameAndLocation</em> so that Application MQTT clients can see all the UNID of the nodes assigned in the locations they are interested into.</p>
<p>To transmit a message/command to all nodes in the kitchen, an Application MQTT client needs to publish using individual UNID commands (plus endpoints). For example, if the kitchen contains two nodes identified by UNID 32049350 and 32049351, the client can publish the following:</p>
<blockquote class="doxtable">
<p>Topic: <em>ucl/by-unid/32049350/ep0/OnOff/On</em> (Empty payload)<br  />
 Topic: <em>ucl/by-unid/32049351/ep2/OnOff/On</em> (Empty payload)<br  />
 </p>
</blockquote>
<p>When a node is removed from the network, the ResourceDirectory MQTT Client will update the location by publishing without the retain flag at <em>ucl/by-location/&lt;location&gt;/&lt;unid&gt;</em> and <em>ucl/by-unid/&lt;unid&gt;/NameAndLocation</em> with an empty payload without the retain flag.</p>
<h2><a class="anchor" id="autotoc_md131"></a>
By Type</h2>
<p>The by-type namespace is postponed for now, because few PHYs use it. It is always possible to iterate over the by-unid namespace and filter by Cluster or derive the types manually.</p>
<p>The type is based on the ZCL Device Type. The ZCL device ID type is read-only and cannot be changed. In ZigBee, it can be read using the Simple_Desc_Req for each endpoint. The Simple_Desc_rsp contains a 2-byte field named "Application device identifier". This group should work in a similar fashion as the by-location group, except that it is read-only and clients cannot change the device type of a given node.</p>
<h2><a class="anchor" id="autotoc_md132"></a>
By Group</h2>
<p>The ZCL also allows to group nodes with actual user-defined groups. These groups are available under the Groups Cluster (0x0004). The by-group namespace has the advantage of being both editable and addressable directly.</p>
<p>If an IoT Service wants to control a set of nodes that belong to the same group, it can issue the commands directly to the GroupId topic.</p>
<p>A helper component is used to keep track of group membership and capabilities, mimicking the behavior in the <code>by-unid</code> space.</p>
<p><b>Topic:</b> <code>ucl/by-group/&lt;GroupID&gt;/&lt;ClusterName&gt;/Commands/+</code></p>
<p>This is the topic on which the Protocol Controllers will listen for incoming commands that have to be issued to a group of nodes. It works as for any application level clusters, described in <a class="el" href="md_doc__chapter02-_z_c_l-in-uic.html">ZCL in Unify</a>.</p>
<p>Identically, IoT Service will be able to read the list of supported commands for each cluster for a given group. This topic will show the common capabilities of a group, as follows:</p>
<p><b>Topic:</b> <code>ucl/by-group/&lt;GroupID&gt;/&lt;ClusterName&gt;/SupportedCommands</code></p>
<p>The group membership of each node can be seen on the Group cluster topic of the node itself, but a summary is also available under the following topic:</p>
<p><b>Topic:</b> <code>ucl/by-group/&lt;GroupID&gt;/NodeList/&lt;UNID&gt;</code></p>
<p><b>JSON Schema:</b></p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;$schema&quot;: &quot;http://json-schema.org/draft-07/schema#&quot;,</div>
<div class="line">  &quot;title&quot;: &quot;Group UNID list&quot;,</div>
<div class="line">  &quot;description&quot;: &quot;List of endpoints under a UNID assigned to individual groups.&quot;,</div>
<div class="line">  &quot;type&quot;: &quot;object&quot;,</div>
<div class="line">  &quot;properties&quot;: {</div>
<div class="line">    &quot;value&quot;: {</div>
<div class="line">       &quot;type&quot;: &quot;array&quot;,</div>
<div class="line">        &quot;items&quot;: {</div>
<div class="line">          &quot;type&quot;: &quot;integer&quot;,</div>
<div class="line">          &quot;minimum&quot;: 1,</div>
<div class="line">          &quot;maximum&quot;: 65535</div>
<div class="line">        },</div>
<div class="line">        &quot;minItems&quot;: 1</div>
<div class="line">    }</div>
<div class="line">  },</div>
<div class="line">  &quot;required&quot;: [</div>
<div class="line">    &quot;value&quot;</div>
<div class="line">  ]</div>
<div class="line">}</div>
</div><!-- fragment --><p>The payload under this topic is an array of endpoints under a given UNID that belong to the group. The array MUST comprise at least 1 element, and an unretained MQTT message with empty payload indicates that a UNID has no more endpoints that are part of the actual group.</p>
<p>Each group may have a name assigned to it. The Name of the group will be advertised at the following topic:</p>
<p><b>Topic:</b> <code>ucl/by-group/&lt;GroupID&gt;/GroupName</code></p>
<p>The JSON-Schema for this topic MUST be identical to the Name attribute defined the <a class="el" href="md_doc__chapter02-_z_c_l-in-uic.html">Group Cluster additional attributes</a>.</p>
<p>The name attribute is pushed individually by IoT Service to Protocol Controllers that forward the information to the PAN nodes. There is a risk that PAN nodes are assigned as part of the same group (e.g., Group 3) but with different names.</p>
<p>A Group Manager component MUST ensure that GroupName is updated and uniform for all nodes that are part of the same group.</p>
<h3><a class="anchor" id="autotoc_md133"></a>
Protocol Controller and Groups Topics</h3>
<p>Protocol Controllers will only listen to incoming commands for groups and dispatch them to individual nodes.</p>
<p>When the group cluster is used to add groups at nodes/enpoints for an end-node, a Protocol Controller MUST subscribe to group command topic, for example using one of the following filters:</p>
<blockquote class="doxtable">
<p>Most specific: <em>ucl/by-group/&lt;groupID&gt;/&lt;ClusterName&gt;/Commands/&lt;CommandName&gt;</em><br  />
 For all commands: <em>ucl/by-group/&lt;groupID&gt;/&lt;ClusterName&gt;/Commands/+</em><br  />
 For all commands in any cluster: <em>ucl/by-group/&lt;groupID&gt;/+/Commands/+</em><br  />
 For any command in any group: <em>ucl/by-group/+/+/Commands/+</em><br  />
 </p>
</blockquote>
<p>The following diagram shows an example of controlling PAN nodes that are part of several groups.</p>
<div class="plantumlgraph">
<img src="inline_umlgraph_21.png" />
</div>
<h3><a class="anchor" id="autotoc_md134"></a>
Group Manager Helper Component</h3>
<p>Groups MAY span several Protocol Controllers, so the capabilities of a group will not be advertised by Protocol Controllers themselves.</p>
<p>A special MQTT Client named the "Group Manager" can alleviate the aggregation logic for other MQTT Clients such as IoT Service that want to make use of the group functionalities.</p>
<p>The Group Manager will monitor group cluster updates and publish to these three topics:</p>
<ul>
<li>ucl/by-group/&lt;GroupID&gt;/&lt;ClusterName&gt;/SupportedCommands</li>
<li>ucl/by-group/&lt;GroupID&gt;/NodeList/&lt;UNID&gt;</li>
<li>ucl/by-group/&lt;GroupID&gt;/GroupName</li>
</ul>
<p>Additionally, the Group Manager MUST publish commands to the individual PAN nodes using the ucl/by-group/&lt;GroupID&gt;/Groups/Commands/AddGroup topic to keep the Group Names consistent.</p>
<p>An example of the interaction between the different components is shown below:</p>
<div class="plantumlgraph">
<img src="inline_umlgraph_22.png" />
</div>
<p>An example for the Group Manager logic is shown in the diagram below.</p>
<div class="plantumlgraph">
<img src="inline_umlgraph_23.png" />
</div>
<h3><a class="anchor" id="autotoc_md135"></a>
IoT Services and Groups</h3>
<p>The IoT services have the ability to define groups using the application level group cluster. <a class="el" href="md_doc__chapter02-_z_c_l-in-uic.html">See Chapter 2 - ZCL in Unify</a>.</p>
<p>With the help of the Group Manager component, the IoT services will get notified of the groups capabilities after each update.</p>
<p>IoT Service SHOULD use names that are already assigned to a GroupID when manipulating node group membership. i.e., if assigning a PAN Node to GroupID 3, it SHOULD use the name already assigned to the group by reading the value published at <code>ucl/by-group/3/GroupName</code>.</p>
<div class="plantumlgraph">
<img src="inline_umlgraph_24.png" />
</div>
 </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
