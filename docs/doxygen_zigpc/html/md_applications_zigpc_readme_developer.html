<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Zigbee Protocol Controller: ZigPC (Beta) Developer Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Zigbee Protocol Controller
   &#160;<span id="projectnumber">1.0.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_applications_zigpc_readme_developer.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">ZigPC (Beta) Developer Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This readme is intended for Unify SDK developers, who are trying to cross compile, install, and run ZigPC on a Raspberry Pi.</p>
<blockquote class="doxtable">
<p><em>NOTE: The current version of the Zigbee Protocol Controller is a Beta release.</em> </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md29"></a>
Build Instructions</h1>
<p>This guide describes how to cross compile the Zigbee Protocol Controller / ZigPC for Raspberry Pi using Docker on your work station. If you haven't already built the Unify docker image, follow the guide in the docker folder <a class="el" href="md_docker_readme_developer.html">readme.md</a> file.</p>
<h2><a class="anchor" id="autotoc_md30"></a>
Set up Gecko SDK</h2>
<p>The Zigbee Protocol controller uses certain functionality in the <a href="https://docs.silabs.com/gecko-platform/latest/">Gecko SDK</a>. The Gecko SDK can be downloaded through <a href="https://www.silabs.com/developers/simplicity-studio">Simplicity Studio</a>. The ZigPC uses the <a href="https://www.silabs.com/developers/zigbee-emberznet">EmberZNet library</a> provided through the Gecko Platform. See the <a href="https://www.silabs.com/documents/public/application-notes/AN0822-simplicity-studio-user-guide.pdf">AN0822: Simplicity Studio User's Guide</a> for more information. In summary, select the EmberZNet library at installation time or, when creating a new project, select "Manage SDKs" followed by "Customize Installation".</p>
<p>After EmberZNet/GeckoSDK is installed, locate its path (e.g., /opt/SimplicityStudio_v5/developer/sdks/gecko_sdk_suite/v3.1). Currently, v3.1 is the only supported version. Set an environment variable $GSDK_LOCATION for this path.</p>
<h2><a class="anchor" id="autotoc_md31"></a>
Cross Compiling for Raspberry Pi Using Docker</h2>
<blockquote class="doxtable">
<p>Cross compilation builds currently supports only the Raspberry Pi OS Buster. </p>
</blockquote>
<p>From the root of the Unify source directory, run the following:</p>
<ul>
<li>Build the Docker container image: <div class="fragment"><div class="line">cd docker</div>
<div class="line">./build_docker.sh armhf uic_armhf</div>
<div class="line">cd ..</div>
</div><!-- fragment --></li>
<li>Run the container with the GSDK locations mounted: <div class="fragment"><div class="line">docker run -it --rm \</div>
<div class="line">  --env GSDK_LOCATION \</div>
<div class="line">  -v`pwd`:`pwd` \</div>
<div class="line">  -w `pwd` \</div>
<div class="line">  -v ${GSDK_LOCATION}:${GSDK_LOCATION} \</div>
<div class="line">  uic_armhf</div>
</div><!-- fragment --></li>
</ul>
<p>Alternatively, use the provided runDocker.sh script in the docker directory. Fill out the GSDK_LOCATION and UIC_REPO paths in the script to properly set up the docker image.</p>
<h2><a class="anchor" id="autotoc_md32"></a>
Compiling</h2>
<p>To compile, run these commands from the top level Unify directory, inside the Docker container:</p>
<div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake -GNinja -DCMAKE_TOOLCHAIN_FILE=../cmake/armhf_debian.cmake ..</div>
<div class="line">ninja               # Build binaries</div>
<div class="line">ninja doxygen       # Build doxygen documentation (optional)</div>
<div class="line">ninja package       # Build Debian Installers (optional)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md33"></a>
Advanced Feature - Run Raspberry Pi Unit Tests in Docker on the Host</h2>
<p>You can run the Raspberry Pi unit tests (and ZigPC binary) within Docker on the Host machine by using QEMU to emulate the ARM architecture, and binfmt in the kernel, to tell Linux OS to run the ARM binaries within QEMU.</p>
<p>To run the unit tests within Docker on the Host machine, run the following command in the Host (not in the Docker container):</p>
<div class="fragment"><div class="line">docker run --user 0 --privileged --rm -it uic_armhf update-binfmts --enable</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>NB: This command needs to be run once after each restart of the Host machine. </p>
</blockquote>
<p>After enabling this you can run the unittests by issuing following command in the <code>uic_armhf</code> docker image in the build directory:</p>
<div class="fragment"><div class="line">ninja test</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md34"></a>
Install Instructions</h1>
<p>Unify Installation is documented in the main README.md.</p>
<h1><a class="anchor" id="autotoc_md35"></a>
Reading Console Logs</h1>
<p>ZigPC is built on top of the Z3Gateway, which is the GSDK App Builder project. Because Z3Gateway uses the SiLabs Ember Application framework, logs from the framework will be shown as a part of ZigPC console logs.</p>
<p>After ZigPC is launched, the logs from ZigPC will be associated with a timestamp, log level, and a tag in the following format:</p>
<p><code>LOG_TIMESTAMP &lt;LOG_LEVEL&gt; [LOG_TAG] LOG_MESSAGE</code></p>
<p><code>&lt;LOG_LEVEL&gt;</code> corresponds to the following:</p><ul>
<li><code>&lt;d&gt;</code>: Debug log</li>
<li><code>&lt;i&gt;</code>: Info log</li>
<li><code>&lt;w&gt;</code>: Warning log</li>
<li><code>&lt;e&gt;</code>: Error log</li>
<li><code>&lt;c&gt;</code>: Critical log</li>
</ul>
<p>NOTE: Any log that doesn't follow the above format is assumed to be part of printed output from the Ember Application framework.</p>
<p>The following snippet is a snippet of example logs to expect:</p>
<div class="fragment"><div class="line">zigpc --zigpc.serial /dev/ttyACM0 --mqtt.host 0.0.0.0 --mqtt.port 1883 --datastore.file zigpc.db</div>
<div class="line"># 2020-11-05 10:55:36:314815 &lt;d&gt; [sl_log] Setting log level to debug</div>
<div class="line"># 2020-11-05 10:55:36:315475 &lt;d&gt; [uic_component_fixtures] Completed: UIC Signal Handler</div>
<div class="line"># ...</div>
<div class="line"># ...</div>
<div class="line"># 2020-11-05 10:55:36:326455 &lt;d&gt; [uic_component_fixtures] Completed: UIC STDIN</div>
<div class="line"># 2020-11-05 10:55:36:326674 &lt;d&gt; [uic_component_fixtures] Completed: ZIGPC Config</div>
<div class="line"># [linux-serial debug] emberSerialInit()</div>
<div class="line"># ...</div>
<div class="line"># ...</div>
<div class="line"># 2020-11-05 10:55:37:961488 &lt;d&gt; [zigpc_smartstart_process] SmartStart Manager Reset with new Gateway</div>
<div class="line"># 2020-11-05 10:55:37:961592 &lt;d&gt; [mqtt_client] Subscribing to: ucl/SmartStart/List</div>
<div class="line"># 2020-11-05 10:55:37:961802 &lt;d&gt; [mqtt_client] Subscription to ucl/by-unid/+/+/OnOff/+/ successful</div>
<div class="line"># 2020-11-05 10:55:37:961979 &lt;d&gt; [mqtt_client] Subscription to ucl/SmartStart/List successful</div>
<div class="line"># ZigPC&gt;</div>
</div><!-- fragment --><p>The <code>ZigPC&gt;</code> prompt can be used to carry out common Protocol Controller functions. Typing "help" brings up the currently supported functions:</p>
<div class="fragment"><div class="line">ZigPC&gt; help</div>
<div class="line">==================================================</div>
<div class="line">UIC Command line interface Help:</div>
<div class="line">==================================================</div>
<div class="line">exit  :Exit the application</div>
<div class="line">help  :Prints help</div>
<div class="line">info  :Execute &#39;info&#39; command accessible from the EmberAf CLI</div>
<div class="line">log_level d|i||w|e|c:Set log levelDEBUG | INFO | WARNING | ERROR | CRITICAL</div>
<div class="line">==================================================</div>
<div class="line">Tip: log_level c to reduce the verbosity of log</div>
<div class="line">==================================================</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md36"></a>
Changing Log Levels</h2>
<p>Changing the log levels can be achieved using the log_level command in the "ZigPC&gt;" console on ZigPC. The following formats are supported for this command:</p>
<ul>
<li><code>log_level &lt;level&gt;</code></li>
<li><code>log_level &lt;tag&gt;,&lt;level&gt;</code></li>
</ul>
<p><code>&lt;tag&gt;</code> corresponds to any of the tags you see in the logs (i.e., <a class="el" href="structmqtt__client.html">mqtt_client</a>)</p>
<p><code>&lt;level&gt;</code> corresponds to any one of the following (can be applied overall or to a particular log_tag):</p><ul>
<li>"off": turn off logs</li>
<li>"d": Show logs up to debug levels (critical, errors, warnings, info, debug)</li>
<li>"i": Show logs up to info levels (critical, errors, warnings, info)</li>
<li>"w": Show logs up to warning levels (critical, errors, warnings)</li>
<li>"e": Show logs up to error levels (critical, errors)</li>
<li>"c": Show logs up to critical levels (critical</li>
</ul>
<p><br  />
<br  />
</p>
<h1><a class="anchor" id="autotoc_md37"></a>
Using Zigbee Network Analyzer to Monitor PAN</h1>
<p>The "Network Analyzer" perspective in Silicon Labs Simplicity Studio IDE v5 can be used to analyze the traffic on the Zigbee PAN.</p>
<p>Network activity can be observed based on the UCL commands relayed by ZigPC.</p>
<h2><a class="anchor" id="autotoc_md38"></a>
Installing Simplicity Studio v5</h2>
<p>If you have not done so already, download Simplicity Studio v5 from <a href="https://www.silabs.com/products/development-tools/software/simplicity-studio">https://www.silabs.com/products/development-tools/software/simplicity-studio</a> on a host computer.</p>
<h2><a class="anchor" id="autotoc_md39"></a>
Detecting Devices in Simplicity Studio</h2>
<p>Devices in Simplicity Studio can be detected using any of the following methods:</p>
<h3><a class="anchor" id="autotoc_md40"></a>
Connection via Ethernet Interface</h3>
<p>If the host computer and one of the Zigbee devices are connected via Ethernet (using a Wireless Starter Kit for example: <a href="https://www.silabs.com/development-tools/wireless/efr32xg22-wireless-starter-kit">https://www.silabs.com/development-tools/wireless/efr32xg22-wireless-starter-kit</a>), Simplicity Studio can capture network traffic using this interface. Either an end device or the gateway radio can be connected via Ethernet to perform network capture (since the serial USB connection, which ZigPC uses, can run independently of the Ethernet connection services).</p>
<p>Instructions:</p>
<ol type="1">
<li>Ensure that the radio is assigned an IP address (static or dynamic).</li>
<li>In Studio, navigate from the top menu: Window → Preferences.</li>
<li>In the preferences window, go to the left menu and select: Simplicity Studio → Device Manager → TCP/IP Adapters.</li>
<li>In the TCP/IP Adapters view, add your device's IP Address in the Discovery Subnet Configuration section.</li>
<li>Click on "Apply" and then "OK".</li>
<li>Devices will now appear in the "Debug Adapters" view.</li>
<li>If the device doesn't appear, click on the "Refresh" icon in the "Debug
   Adapters" view.</li>
</ol>
<h3><a class="anchor" id="autotoc_md41"></a>
Connection via Serial USB Interface</h3>
<p>Because the Gateway radio is connected to Raspberry Pi running ZigPC, a test end device should be connected to the host computer.</p>
<p>Instructions:</p>
<ol type="1">
<li>Plug in the end device to the host computer.</li>
<li>Devices will now appear in the "Debug Adapters" view.</li>
<li>If the device doesn't appear, click on the "Refresh" icon in the "Debug
   Adapters" view.</li>
</ol>
<h2><a class="anchor" id="autotoc_md42"></a>
Capturing Network Traffic in Simplicity Studio</h2>
<p>Using the top menu, select Window → Perspective → Network Analyzer.</p>
<p>Then, in the "Debug Adapters" window, right-click on the connected device and click "Connect", then click "Start capture".</p>
<p>This will trigger the Network Analyzer to record PAN events, as shown below:</p>
<p><img src="doc/assets/user_guide-network-analyzer-view.png" alt="" class="inline"/></p>
<p>The middle table, labeled "Transactions", can be used to get a high-level overview of messages sent on the network.</p>
<h2><a class="anchor" id="autotoc_md43"></a>
Decrypting Network Traffic in Simplicity Studio</h2>
<p>ZigPC uses Network key (NWK key) based on the install code. In typical Zigbee applications, the Ember CLI can be used to get this key. However, because the Ember CLI has been disabled in ZigPC, the NWK Key is logged in the ZigPC debug console after the network is opened for joining:</p>
<p>Look for the following pattern:</p>
<div class="fragment"><div class="line">[DEBUG] NWK Key:: ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ</div>
</div><!-- fragment --><p>Extract the NWK key value ( <code>ZZ ZZ ZZ ...</code> sequence in the log above) and add it as a Network Analyzer Security Key using the following instructions:</p><ol type="1">
<li>Open Simplicity Studio v5.</li>
<li>Click from the top menu: Window -&gt; Preferences.</li>
<li>From the left sidebar, select: Network Analyzer -&gt; Decoding -&gt; Security Keys.</li>
<li>Add a New Entry and insert the NWK key as the Key value.</li>
<li>Click Apply then OK.</li>
</ol>
<p>This NWK key can now decrypt network traffic after the node has joined the network.</p>
<p>For more information, see <a href="https://www.silabs.com/documents/public/quick-start-guides/qsg106-efr32-zigbee-pro.pdf">"Section 6: Using the Network Analyzer" in QSG106: Zigbee EmberZNet PRO Quick-Start Guide</a>.</p>
<p>For example, the following decrypted transactions are seen when the SmartStart addition is performed to add an end device to the PAN using the Install Code based DSK:</p>
<p><img src="doc/assets/user_guide-network-analyzer-node-add.png" alt="" class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Oct 8 2021 09:58:36 for Zigbee Protocol Controller by <a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
