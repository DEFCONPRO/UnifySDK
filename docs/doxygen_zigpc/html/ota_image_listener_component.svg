<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1307px" preserveAspectRatio="none" style="width:956px;height:1307px;" version="1.1" viewBox="0 0 956 1307" width="956px" zoomAndPan="magnify"><defs><filter height="300%" id="f1p6y6bp1063od" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="281" x="334" y="28.708">OTA Image Listener component</text><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="43.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="603" y="351.3672"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="43.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="603" y="545.1641"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="603" y="719.5625"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="145.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="603" y="816.9609"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="43.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="603" y="1058.8906"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="603" y="1159.1563"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="143.6641" style="stroke:#000000;stroke-width:2.0;" width="815.5" x="111" y="452.6328"/><line style="stroke:#A80036;stroke-width:1.0;" x1="194" x2="194" y1="167.4375" y2="603.2969"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="194" x2="194" y1="603.2969" y2="631.2969"/><line style="stroke:#A80036;stroke-width:1.0;" x1="194" x2="194" y1="631.2969" y2="631.2969"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="194" x2="194" y1="631.2969" y2="659.2969"/><line style="stroke:#A80036;stroke-width:1.0;" x1="194" x2="194" y1="659.2969" y2="970.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="194" x2="194" y1="970.625" y2="998.625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="194" x2="194" y1="998.625" y2="1110.0234"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="194" x2="194" y1="1110.0234" y2="1138.0234"/><line style="stroke:#A80036;stroke-width:1.0;" x1="194" x2="194" y1="1138.0234" y2="1264.5547"/><line style="stroke:#A80036;stroke-width:1.0;" x1="607.5" x2="607.5" y1="167.4375" y2="603.2969"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="607.5" x2="607.5" y1="603.2969" y2="631.2969"/><line style="stroke:#A80036;stroke-width:1.0;" x1="607.5" x2="607.5" y1="631.2969" y2="631.2969"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="607.5" x2="607.5" y1="631.2969" y2="659.2969"/><line style="stroke:#A80036;stroke-width:1.0;" x1="607.5" x2="607.5" y1="659.2969" y2="970.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="607.5" x2="607.5" y1="970.625" y2="998.625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="607.5" x2="607.5" y1="998.625" y2="1110.0234"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="607.5" x2="607.5" y1="1110.0234" y2="1138.0234"/><line style="stroke:#A80036;stroke-width:1.0;" x1="607.5" x2="607.5" y1="1138.0234" y2="1264.5547"/><line style="stroke:#A80036;stroke-width:1.0;" x1="861.5" x2="861.5" y1="167.4375" y2="603.2969"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="861.5" x2="861.5" y1="603.2969" y2="631.2969"/><line style="stroke:#A80036;stroke-width:1.0;" x1="861.5" x2="861.5" y1="631.2969" y2="631.2969"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="861.5" x2="861.5" y1="631.2969" y2="659.2969"/><line style="stroke:#A80036;stroke-width:1.0;" x1="861.5" x2="861.5" y1="659.2969" y2="970.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="861.5" x2="861.5" y1="970.625" y2="998.625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="861.5" x2="861.5" y1="998.625" y2="1110.0234"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="861.5" x2="861.5" y1="1110.0234" y2="1138.0234"/><line style="stroke:#A80036;stroke-width:1.0;" x1="861.5" x2="861.5" y1="1138.0234" y2="1264.5547"/><rect fill="#FEFECE" filter="url(#f1p6y6bp1063od)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="142" x="121" y="132.1406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="128" x="128" y="152.1357">Protocol Controller</text><rect fill="#FEFECE" filter="url(#f1p6y6bp1063od)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="142" x="121" y="1263.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="128" x="128" y="1283.5498">Protocol Controller</text><rect fill="#FEFECE" filter="url(#f1p6y6bp1063od)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="43" x="584.5" y="132.1406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="29" x="591.5" y="152.1357">OTA</text><rect fill="#FEFECE" filter="url(#f1p6y6bp1063od)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="43" x="584.5" y="1263.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="29" x="591.5" y="1283.5498">OTA</text><rect fill="#FEFECE" filter="url(#f1p6y6bp1063od)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="105" x="807.5" y="132.1406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="814.5" y="152.1357">MQTT Broker</text><rect fill="#FEFECE" filter="url(#f1p6y6bp1063od)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="105" x="807.5" y="1263.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="814.5" y="1283.5498">MQTT Broker</text><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="43.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="603" y="351.3672"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="43.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="603" y="545.1641"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="603" y="719.5625"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="145.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="603" y="816.9609"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="43.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="603" y="1058.8906"/><rect fill="#FFFFFF" filter="url(#f1p6y6bp1063od)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="603" y="1159.1563"/><path d="M320,182.4375 L320,252.4375 L891,252.4375 L891,192.4375 L881,182.4375 L320,182.4375 " fill="#FBFB77" filter="url(#f1p6y6bp1063od)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M881,182.4375 L881,192.4375 L891,192.4375 L881,182.4375 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="548" x="326" y="199.5044">- 'image_available' callback with data containing meta data the newly available image.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="375" x="326" y="214.6372">- 'image_base_path' path used to download the images to.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="550" x="326" y="229.77">- 'cache_size' defines the max amount of images to be cached by the ota component.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="439" x="326" y="244.9028">- 'timeout' the time before a get function returns with result TIMEOUT</text><polygon fill="#A80036" points="596,279.1016,606,283.1016,596,287.1016,600,283.1016" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="194" x2="602" y1="283.1016" y2="283.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="390" x="201" y="278.0356">init(image_available, image_base_path, cache_size, timeout)</text><path d="M360,296.1016 L360,321.1016 L852,321.1016 L852,306.1016 L842,296.1016 L360,296.1016 " fill="#FBFB77" filter="url(#f1p6y6bp1063od)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M842,296.1016 L842,306.1016 L852,306.1016 L842,296.1016 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="471" x="366" y="313.1685">we have 2 ways to subscribe for images; 1. via uiid 2. via unid's (uiid, unid)</text><polygon fill="#A80036" points="591,347.3672,601,351.3672,591,355.3672,595,351.3672" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="194" x2="597" y1="351.3672" y2="351.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="201" y="346.3013">subscribe_uiid(uiid)</text><polygon fill="#A80036" points="850,376.5,860,380.5,850,384.5,854,380.5" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="613" x2="856" y1="380.5" y2="380.5"/><text fill="#0039FB" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="620" y="375.4341">ucl/OTA/info/&lt;UIID&gt;/all</text><polygon fill="#A80036" points="205,390.5,195,394.5,205,398.5,201,394.5" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="199" x2="607" y1="394.5" y2="394.5"/><rect fill="#EEEEEE" filter="url(#f1p6y6bp1063od)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="949" x="0" y="423.0664"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="949" y1="423.0664" y2="423.0664"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="949" y1="426.0664" y2="426.0664"/><rect fill="#EEEEEE" filter="url(#f1p6y6bp1063od)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="131" x="409" y="412.5"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="112" x="415" y="428.5669">node discovery</text><path d="M111,452.6328 L188,452.6328 L188,459.6328 L178,469.6328 L111,469.6328 L111,452.6328 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="143.6641" style="stroke:#000000;stroke-width:2.0;" width="815.5" x="111" y="452.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="126" y="465.6997">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="180" x="203" y="464.8433">[for n nodes in the network]</text><path d="M336,474.7656 L336,514.7656 L876,514.7656 L876,484.7656 L866,474.7656 L336,474.7656 " fill="#FBFB77" filter="url(#f1p6y6bp1063od)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M866,474.7656 L866,484.7656 L876,484.7656 L866,474.7656 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="519" x="342" y="491.8325">The PC is responsible to obtian nodes and their corresponding fwk versioning info.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="477" x="342" y="506.9653">Secondly, it needs to tell us when a node is not part of a network anymore.</text><polygon fill="#A80036" points="591,541.1641,601,545.1641,591,549.1641,595,545.1641" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="194" x2="597" y1="545.1641" y2="545.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="201" y="540.0981">subscribe_unid(unid, uiid)</text><polygon fill="#A80036" points="850,570.2969,860,574.2969,850,578.2969,854,574.2969" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="613" x2="856" y1="574.2969" y2="574.2969"/><text fill="#0039FB" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="620" y="569.231">ucl/OTA/info/&lt;UIID&gt;/&lt;UNID&gt;</text><polygon fill="#A80036" points="205,584.2969,195,588.2969,205,592.2969,201,588.2969" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="199" x2="607" y1="588.2969" y2="588.2969"/><path d="M779,664.2969 L779,689.2969 L940,689.2969 L940,674.2969 L930,664.2969 L779,664.2969 " fill="#FBFB77" filter="url(#f1p6y6bp1063od)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M930,664.2969 L930,674.2969 L940,674.2969 L930,664.2969 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="785" y="681.3638">new image coming in!</text><polygon fill="#A80036" points="624,715.5625,614,719.5625,624,723.5625,620,719.5625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="618" x2="861" y1="719.5625" y2="719.5625"/><text fill="#00003C" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="630" y="714.4966">ucl/OTA/info/&lt;UIID&gt;/all/+</text><polygon fill="#A80036" points="205,744.6953,195,748.6953,205,752.6953,201,748.6953" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="199" x2="607" y1="748.6953" y2="748.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="335" x="211" y="743.6294">image_available(uiid, unid, new_version, apply_after)</text><path d="M41,761.6953 L41,786.6953 L342,786.6953 L342,771.6953 L332,761.6953 L41,761.6953 " fill="#FBFB77" filter="url(#f1p6y6bp1063od)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M332,761.6953 L332,771.6953 L342,771.6953 L332,761.6953 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="47" y="778.7622">protocol controller decides to get the image</text><polygon fill="#A80036" points="591,812.9609,601,816.9609,591,820.9609,595,816.9609" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="194" x2="597" y1="816.9609" y2="816.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="201" y="811.895">get(uiid, image_ready_cb)</text><polygon fill="#A80036" points="850,842.0938,860,846.0938,850,850.0938,854,846.0938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="613" x2="856" y1="846.0938" y2="846.0938"/><text fill="#0039FB" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="620" y="841.0278">ucl/OTA/data/&lt;UIID&gt;</text><polygon fill="#A80036" points="850,871.2266,860,875.2266,850,879.2266,854,875.2266" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="613" x2="856" y1="875.2266" y2="875.2266"/><text fill="#6C2A0D" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="620" y="870.1606">ucl/OTA/data/&lt;UIID&gt;/get</text><polygon fill="#A80036" points="624,900.3594,614,904.3594,624,908.3594,620,904.3594" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="618" x2="861" y1="904.3594" y2="904.3594"/><text fill="#6C2A0D" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="630" y="899.2935">ucl/OTA/data/&lt;UIID&gt;</text><polygon fill="#A80036" points="850,929.4922,860,933.4922,850,937.4922,854,933.4922" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="613" x2="856" y1="933.4922" y2="933.4922"/><text fill="#2B3618" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="624" y="928.4263">ucl/OTA/data/&lt;UIID&gt;</text><polygon fill="#A80036" points="205,958.625,195,962.625,205,966.625,201,962.625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="199" x2="607" y1="962.625" y2="962.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="211" y="957.5591">image_ready_cb(image_meta)</text><path d="M5,1003.625 L5,1028.625 L380,1028.625 L380,1013.625 L370,1003.625 L5,1003.625 " fill="#FBFB77" filter="url(#f1p6y6bp1063od)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M370,1003.625 L370,1013.625 L380,1013.625 L370,1003.625 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="354" x="11" y="1020.6919">protocol controller sends updates to the image_listener</text><polygon fill="#A80036" points="591,1054.8906,601,1058.8906,591,1062.8906,595,1058.8906" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="194" x2="597" y1="1058.8906" y2="1058.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="299" x="201" y="1053.8247">update_*status*(uiid, unid, endpoint, *status*)</text><polygon fill="#A80036" points="850,1084.0234,860,1088.0234,850,1092.0234,854,1088.0234" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="613" x2="856" y1="1088.0234" y2="1088.0234"/><text fill="#00003C" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="225" x="620" y="1082.9575">ucl/by-unid/&lt;UNID&gt;/OTA/&lt;UIID&gt;/+</text><polygon fill="#A80036" points="205,1098.0234,195,1102.0234,205,1106.0234,201,1102.0234" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="199" x2="607" y1="1102.0234" y2="1102.0234"/><polygon fill="#A80036" points="591,1155.1563,601,1159.1563,591,1163.1563,595,1159.1563" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="194" x2="597" y1="1159.1563" y2="1159.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136" x="201" y="1154.0903">unregister_unid(unid)</text><polygon fill="#A80036" points="850,1184.2891,860,1188.2891,850,1192.2891,854,1188.2891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="608" x2="856" y1="1188.2891" y2="1188.2891"/><text fill="#00003C" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="225" x="615" y="1183.2231">ucl/by-unid/&lt;UNID&gt;/OTA/&lt;UIID&gt;/+</text><polygon fill="#A80036" points="596,1213.4219,606,1217.4219,596,1221.4219,600,1217.4219" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="194" x2="602" y1="1217.4219" y2="1217.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97" x="201" y="1212.356">unregister(uiid)</text><polygon fill="#A80036" points="596,1242.5547,606,1246.5547,596,1250.5547,600,1246.5547" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="194" x2="602" y1="1246.5547" y2="1246.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="86" x="201" y="1241.4888">clear_cache()</text><rect fill="#DDDDDD" height="75.1875" rx="5" ry="5" style="stroke:#000000;stroke-width:1.0;" width="212" x="368" y="47.9531"/><text fill="#0039FB" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="131" x="374" y="65.9482">MQTT Subscription</text><text fill="#2B3618" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="132" x="374" y="82.2451">MQTT Unsubscribe</text><text fill="#00003C" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="186" x="374" y="98.542">Retained MQTT Publication</text><text fill="#6C2A0D" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="200" x="374" y="114.8389">Unretained MQTT Publication</text><!--MD5=[e3dfd8c0a26a5174afcf0ce14cf6483b]
@startuml ota_image_listener_component.svg
title OTA Image Listener component
legend top
<font color=#0039FB>MQTT Subscription</font>
<font color=#2b3618>MQTT Unsubscribe</font>
<font color=#00003C>Retained MQTT Publication</font>
<font color=#6C2A0D>Unretained MQTT Publication</font>
endlegend

participant "Protocol Controller" as PC
participant "OTA" as IL
participant "MQTT Broker" as MQTT

note over IL
- 'image_available' callback with data containing meta data the newly available image.
- 'image_base_path' path used to download the images to.
- 'cache_size' defines the max amount of images to be cached by the ota component.
- 'timeout' the time before a get function returns with result TIMEOUT
end note
PC-> IL: init(image_available, image_base_path, cache_size, timeout)
note over IL: we have 2 ways to subscribe for images; 1. via uiid 2. via unid's (uiid, unid)
PC->IL:subscribe_uiid(uiid)
activate IL
IL->MQTT:<font color=#0039FB>ucl/OTA/info/<UIID>/all</font>
IL- ->PC
deactivate IL
== node discovery ==
loop for n nodes in the network
note over IL
The PC is responsible to obtian nodes and their corresponding fwk versioning info.
Secondly, it needs to tell us when a node is not part of a network anymore.
end note
PC->IL:subscribe_unid(unid, uiid)
activate IL
IL->MQTT:<font color=#0039FB>ucl/OTA/info/<UIID>/<UNID></font>
IL- ->PC
deactivate IL
end
...
...
note over MQTT: new image coming in!
MQTT->IL: <font color=#00003C>ucl/OTA/info/<UIID>/all/+</font>
activate IL
IL->PC:image_available(uiid, unid, new_version, apply_after)
deactivate IL
note over PC: protocol controller decides to get the image
PC->IL: get(uiid, image_ready_cb)
activate IL
IL->MQTT:<font color=#0039FB>ucl/OTA/data/<UIID></font>
IL->MQTT:<font color=#6C2A0D>ucl/OTA/data/<UIID>/get</font>
MQTT->IL:<font color=#6C2A0D>ucl/OTA/data/<UIID></font>
IL->MQTT:<font color=#2b3618> ucl/OTA/data/<UIID></font>
IL->PC: image_ready_cb(image_meta)
deactivate IL

...
note over PC: protocol controller sends updates to the image_listener
PC->IL: update_*status*(uiid, unid, endpoint, *status*)
activate IL
IL-> MQTT: <font color=#00003C>ucl/by-unid/<UNID>/OTA/<UIID>/+
IL- ->PC
deactivate IL
...

PC->IL:unregister_unid(unid)
activate IL
IL-> MQTT: <font color=#00003C>ucl/by-unid/<UNID>/OTA/<UIID>/+
deactivate IL
PC->IL: unregister(uiid)
PC->IL: clear_cache()
@enduml

PlantUML version 1.2021.00(Sun Jan 10 10:25:05 UTC 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: ANSI_X3.4-1968
Language: en
Country: US
--></g></svg>