<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Unify SDK User Guide: Image Provider User&#39;s Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Unify SDK User Guide
   &#160;<span id="projectnumber">1.0.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_applications_image_provider_readme_user.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Image Provider User's Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Image Provider is a generic application that allows storing and distributing OTA Firmware images for Protocol Controllers over MQTT.</p>
<p>For more details about the interactions between the Image Provider and Protocol Controllers, see the Unify specifications - Common OTA FW Update Service chapter.</p>
<p>The Image Provider application is required for most Protocol Controller to access firmware images for a given node. Protocol Controllers running without the Image Provider application available will most likely not be able to provide OTA functionalities.</p>
<h1><a class="anchor" id="autotoc_md118"></a>
Running the Image Provider</h1>
<h2><a class="anchor" id="autotoc_md119"></a>
Using Systemd Service</h2>
<p>The best way to run the Image Provider is using the Systemd service that is installed with the Debian installer. For more information, see <a class="el" href="index.html#md_README">README.md</a>.</p>
<h2><a class="anchor" id="autotoc_md120"></a>
Using the Command Line</h2>
<p>Alternatively, you can run the Image Provider by executing <code>uic-image-provider</code>. You can configure the MQTT server, database path, through command line options. For details about options, run the following command:</p>
<div class="fragment"><div class="line">pi@unify:uic-image-provider --help</div>
</div><!-- fragment --><p>Make sure that you do not run the Image Provider both as a service and using the command line.</p>
<div class="fragment"><div class="line">pi@unify:~ $ service uic-image-provider status</div>
<div class="line">● uic-image-provider.service - Unified IoT OTA Image Provider</div>
<div class="line">   Loaded: loaded (/lib/systemd/system/uic-image-provider.service; enabled; vendor preset: enabled)</div>
<div class="line">   Active: active (running) since Tue 2021-08-17 14:50:26 CEST; 1 day 20h ago</div>
<div class="line"> Main PID: 13235 (uic-image-provi)</div>
<div class="line">    Tasks: 2 (limit: 4915)</div>
<div class="line">   CGroup: /system.slice/uic-image-provider.service</div>
<div class="line">           └─13235 /usr/bin/uic-image-provider</div>
</div><!-- fragment --><p>If the service is running, stop it using the following command before you run the application manually:</p>
<div class="fragment"><div class="line">pi@unify:~ $ service uic-image-provider stop</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md121"></a>
Using the Image Provider</h1>
<h2><a class="anchor" id="autotoc_md122"></a>
OTA Folder Structure</h2>
<p>The Image Provider will use the configured <b>image_provider.image_path</b> to store a JSON file that will represent the list of available images.</p>
<p>The <em>images.json</em> file must be configured to indicate which images to advertise to the MQTT broker/Protocol Controllers.</p>
<div class="fragment"><div class="line">pi@unify:/var/lib/uic-image-provider $ tree</div>
<div class="line">.</div>
<div class="line">├── images.json</div>
<div class="line">└── updates</div>
<div class="line">    ├── image_0.jpg</div>
<div class="line">    ├── image_1.jpg</div>
<div class="line">    └── image_2.jpg</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md123"></a>
Metadata File Name and Format</h2>
<p>The filename for the metadata is static and must stay <em>images.json</em>.</p>
<p>The Image Provider will poll the images.json for changes with a configurable period. It will then advertise images.</p>
<p>The JSON file must follow the following JSON schema:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;$schema&quot;: &quot;http://json-schema.org/draft-07/schema#&quot;,</div>
<div class="line">  &quot;title&quot;: &quot;Image Provider Metadata file format&quot;,</div>
<div class="line">  &quot;description&quot;: &quot;List of Available Firmwares files for the Image Provider&quot;,</div>
<div class="line">  &quot;definitions&quot;: {</div>
<div class="line">    &quot;Image Entry&quot;: {</div>
<div class="line">      &quot;type&quot;: &quot;object&quot;,</div>
<div class="line">      &quot;properties&quot;: {</div>
<div class="line">        &quot;FileName&quot;: {</div>
<div class="line">          &quot;type&quot;: &quot;string&quot;</div>
<div class="line">        },</div>
<div class="line">        &quot;Uiid&quot;: {</div>
<div class="line">          &quot;type&quot;: &quot;string&quot;</div>
<div class="line">        },</div>
<div class="line">        &quot;Unid&quot;: {</div>
<div class="line">          &quot;type&quot;: &quot;array&quot;,</div>
<div class="line">          &quot;items&quot;: {</div>
<div class="line">            &quot;type&quot;: &quot;string&quot;</div>
<div class="line">          }</div>
<div class="line">        },</div>
<div class="line">        &quot;Version&quot;: {</div>
<div class="line">          &quot;type&quot;: &quot;string&quot;</div>
<div class="line">        },</div>
<div class="line">        &quot;ApplyAfter&quot;: {</div>
<div class="line">          &quot;type&quot;: &quot;string&quot;</div>
<div class="line">        },</div>
<div class="line">        &quot;Md5&quot;: {</div>
<div class="line">          &quot;type&quot;: &quot;string&quot;</div>
<div class="line">        }</div>
<div class="line">      },</div>
<div class="line">      &quot;required&quot;: [</div>
<div class="line">        &quot;FileName&quot;,</div>
<div class="line">        &quot;Uiid&quot;,</div>
<div class="line">        &quot;Unid&quot;,</div>
<div class="line">        &quot;Version&quot;,</div>
<div class="line">        &quot;ApplyAfter&quot;,</div>
<div class="line">        &quot;Md5&quot;</div>
<div class="line">      ]</div>
<div class="line">    }</div>
<div class="line">  },</div>
<div class="line">  &quot;type&quot;: &quot;object&quot;,</div>
<div class="line">  &quot;properties&quot;: {</div>
<div class="line">    &quot;Version&quot;: {</div>
<div class="line">      &quot;type&quot;: &quot;string&quot;</div>
<div class="line">    },</div>
<div class="line">    &quot;Images&quot;: {</div>
<div class="line">      &quot;type&quot;: &quot;array&quot;,</div>
<div class="line">      &quot;items&quot;: {</div>
<div class="line">        &quot;$ref&quot;: &quot;#/definitions/Image Entry&quot;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  },</div>
<div class="line">  &quot;required&quot;: [</div>
<div class="line">    &quot;Version&quot;,</div>
<div class="line">    &quot;Images&quot;</div>
<div class="line">  ]</div>
<div class="line">}</div>
</div><!-- fragment --><p>This is a sample <em>images.json</em> file advertising 3 images.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;Version&quot;: &quot;1&quot;,</div>
<div class="line">  &quot;Images&quot;: [</div>
<div class="line">    {</div>
<div class="line">      &quot;FileName&quot;: &quot;updates/image_0.jpg&quot;,</div>
<div class="line">      &quot;Uiid&quot;: &quot;ZWave-000-002-003_EU&quot;,</div>
<div class="line">      &quot;Unid&quot;: [],</div>
<div class="line">      &quot;Version&quot;: &quot;1.0.2&quot;,</div>
<div class="line">      &quot;ApplyAfter&quot;: &quot;2021-06-29T16:39:57+02:00&quot;,</div>
<div class="line">      &quot;Md5&quot;: &quot;AxDtA0hVrAYcFFA8S85WjQ==&quot;</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">      &quot;FileName&quot;: &quot;updates/image_1.jpg&quot;,</div>
<div class="line">      &quot;Uiid&quot;: &quot;ZWave-001-002-003_EU&quot;,</div>
<div class="line">      &quot;Unid&quot;: [&quot;zw-C87E6FB8-0005&quot;],</div>
<div class="line">      &quot;Version&quot;: &quot;1.0.2&quot;,</div>
<div class="line">      &quot;ApplyAfter&quot;: &quot;2021-06-29T16:39:57+02:00&quot;,</div>
<div class="line">      &quot;Md5&quot;: &quot;JQuIx5gfzUtpPVS59wY34g==&quot;</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">      &quot;FileName&quot;: &quot;updates/image_2.jpg&quot;,</div>
<div class="line">      &quot;Uiid&quot;: &quot;ZWave-002-002-003_EU&quot;,</div>
<div class="line">      &quot;Unid&quot;: [&quot;zw-C87E6FB8-0006&quot;, &quot;zw-C87E6FB8-0007&quot;, &quot;zw-C87E6FB8-0008&quot;],</div>
<div class="line">      &quot;Version&quot;: &quot;1.0.3&quot;,</div>
<div class="line">      &quot;ApplyAfter&quot;: &quot;2021-06-29T16:42:59+02:00&quot;,</div>
<div class="line">      &quot;Md5&quot;: &quot;GEyaucM09e025pO/FeIuZQ==&quot;</div>
<div class="line">    }</div>
<div class="line">  ]</div>
<div class="line">}</div>
</div><!-- fragment --><p>The following parameters must be provided for each Firmware entry:</p>
<ul>
<li><b>FileName</b> : This is the relative path from the <em>images.json</em> to the firmware files. Absolute path can be used.</li>
<li><b>Uiid</b> : The Unique Image Identifier. This allows Protocol Controller to identify know which nodes can receive the firmware. More details about how to build the UIID is given in each individual Protocol Controller</li>
<li><b>Unid</b> : A list of UNIDs that should receive the update. An empty array will instruct the Protocol Controller to update all compatible nodes. An array with UNIDs will instruct the Protocol Controller to update only the list of nodes in this array.</li>
<li><b>Version</b> : The version of the firmware file. It may be used by protocol controllers to prevent a downgrade or attempting to upgrade to the same version. The construct and interpretation of the version string is Protocol Controller specific</li>
<li><b>ApplyAfter</b> : A timestamp encoded using RFC 3339, that will indicate when to first attempt to apply the Firmware Update. A date in the past will instruct Protocol Controllers to initiate the firmware update as soon as possible.</li>
<li><b>Md5</b> : A checksum that will verify that the data located in the <em>fileName</em> is coherent with what we expect.</li>
</ul>
<h3><a class="anchor" id="autotoc_md124"></a>
Md5 Checksum calculation</h3>
<p>The Md5 checksum value must be set to a base64 encoded md5 digest of image file.</p>
<p>In Rust, the checksum can be generated like this:</p>
<div class="fragment"><div class="line">base64::encode(md5::compute(buffer).to_vec());</div>
</div><!-- fragment --><p>The checksum string can also be created using openssl:</p>
<div class="fragment"><div class="line">cat ZW_SensorPir_7.15.4_227_ZGM130S_REGION_EU_DEBUG_v255.gbl | openssl dgst -binary -md5 | openssl base64</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md125"></a>
Output Examples</h2>
<div class="fragment"><div class="line">pi@unify:~ $ uic-image-provider --help</div>
<div class="line"> </div>
<div class="line">Usage: uic-image-provider [Options]</div>
<div class="line"> </div>
<div class="line">Options:</div>
<div class="line">  --conf arg (=/etc/uic/uic.cfg)        Config file in YAML format</div>
<div class="line">  --help                                Print this help message and quit</div>
<div class="line">  --sample_conf_file                    Print sample YAML config file that can</div>
<div class="line">                                        be passed to --conf option</div>
<div class="line">  --version                             Print version information and quit</div>
<div class="line"> </div>
<div class="line">Following options can also be in a Config file.</div>
<div class="line"> Options and values passed on command line here take precedence over the options and values in config file:</div>
<div class="line">  --mqtt.host arg (=localhost)          MQTT broker hostname or IP</div>
<div class="line">  --mqtt.port arg (=1883)               MQTT broker port</div>
<div class="line">  --log.level arg (=d)                  Log Level (d,i,w,e,c)</div>
<div class="line">  --log.tag_level arg                   Tag based log level</div>
<div class="line">                                        Format: &lt;tag&gt;:&lt;severity&gt;,</div>
<div class="line">                                        &lt;tag&gt;:&lt;severity&gt;, ...</div>
<div class="line">  --datastore.file arg (=/var/lib/uic/database.db)</div>
<div class="line">                                        Datastore database file</div>
<div class="line">  --mqtt.client_id arg (=uic-image-provider)</div>
<div class="line">                                        override mqtt client name</div>
<div class="line">  --provider.image_path arg (=/var/lib/uic-image-provider)</div>
<div class="line">                                        image path</div>
<div class="line">  --provider.poll_period arg (=15)      poll period</div>
</div><!-- fragment --><div class="fragment"><div class="line">pi@unify:~ $ uic-image-provider</div>
<div class="line">2021-07-07 16:37:37:790401 &lt;d&gt; [sl_log] Setting log level to debug</div>
<div class="line">2021-07-07 16:37:37:799641 &lt;i&gt; [mqtt_client] connecting to &quot;localhost&quot; port:1883</div>
<div class="line">2021-07-07 16:37:37:802863 &lt;i&gt; [image_watcher] Image storage path /var/lib/uic-image-provider</div>
<div class="line">2021-07-07 16:37:37:803377 &lt;i&gt; [mqtt_client] subscribing to &quot;ucl/OTA/data/+/+/get&quot; qos:0</div>
<div class="line">2021-07-07 16:37:37:805596 &lt;i&gt; [image_watcher] Publishing image announce to &quot;ucl/OTA/info/ZWave-000-002-003_EU/all&quot;</div>
<div class="line">2021-07-07 16:37:37:806087 &lt;i&gt; [image_watcher] Publishing image announce to &quot;ucl/OTA/info/ZWave-002-002-003_EU/zw-C87E6FB8-0006&quot;</div>
<div class="line">2021-07-07 16:37:37:806471 &lt;i&gt; [image_watcher] Publishing image announce to &quot;ucl/OTA/info/ZWave-002-002-003_EU/zw-C87E6FB8-0007&quot;</div>
<div class="line">2021-07-07 16:37:37:806863 &lt;i&gt; [image_watcher] Publishing image announce to &quot;ucl/OTA/info/ZWave-001-002-003_EU/zw-C87E6FB8-0005&quot;</div>
<div class="line">2021-07-07 16:37:41:296142 &lt;i&gt; [image_watcher] Image requested for ZWave-002-002-003_EU/zw-C87E6FB8-0006</div>
<div class="line">2021-07-07 16:37:41:297280 &lt;i&gt; [mqtt_handler] Publishing binary payload to &quot;ucl/OTA/data/ZWave-002-002-003_EU/zw-C87E6FB8-0006&quot;</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Aug 30 2021 13:07:52 for Unify SDK User Guide by <a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
