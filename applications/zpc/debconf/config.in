#!/bin/sh -e
. /usr/share/debconf/confmodule

UIC_CONFDIR=${CPACK_PACKAGING_INSTALL_PREFIX}/etc/uic
UIC_CONFFILE=$UIC_CONFDIR/uic.cfg

if ! grep -q "zpc:" $UIC_CONFFILE
then
  mkdir -p $UIC_CONFDIR
  echo "zpc:" >>  $UIC_CONFFILE
  echo "  serial: /dev/ttyACM0" >> $UIC_CONFFILE
  echo "  rf_region: EU" >> $UIC_CONFFILE
fi
if ! grep -q "datastore:" $UIC_CONFFILE
then
  echo "datastore:" >> $UIC_CONFFILE
  echo "  file: ${CPACK_PACKAGING_INSTALL_PREFIX}/var/lib/uic/zpc.db" >> $UIC_CONFFILE
fi

db_input critical uic-zpc/serial_port || true
db_go
db_get uic-zpc/serial_port
PORT="$RET"
if [ "$RET" = "" ]; then
	PORT="/dev/ttyACM0"
fi

db_input critical uic-zpc/region || true
db_go
db_get uic-zpc/region
REGION="$RET"
if [ "$RET" = "" ]; then
	REGION="EU"
fi

db_input critical uic-zpc/datastore_file || true
db_go
db_get uic-zpc/datastore_file
DSTORE="$RET"
if [ "$RET" = "" ]; then
	DSTORE="${CPACK_PACKAGING_INSTALL_PREFIX}/var/lib/uic/database.db"
fi

# Update configuration file with oucome of configuration
# This is a small state machine that can update the UIC config file, which is written in YAML
state=""
while read line
do
  # Set the state depending on the line read from the config file
  case "$line" in
    "zpc:" | *"serial"* | *"rf_region"*)           # State: zpc
      state="zpc"
      ;;
    "datastore:" | *"file"*)     # State datastore
      state="datastore"
      ;;
    *) state="" ;;    # Set state to empty, Any unknown text, that doesn't begin with '-' or ' '
  esac
  # STM to update entries under 'zpc:' or 'datastore:' (more may be added later)
  case $state in
    "zpc" | "datastore")
      case "$line" in
      "zpc:" | "datastore:")
        echo "$line" ;;                   # Datastore and zpc should not be indented
      *"serial:"*)
        echo "  serial: $PORT" ;;
      *"rf_region:"*)
        echo "  rf_region: $REGION" ;;
      *"file:"*)
        echo "  file: $DSTORE" ;;
      *)
        echo "  $line" ;;                 # Anything inside zpc or datastore we indent
      esac ;;
    *)
      echo "$line" ;;                     # Anything else we just echo the line
  esac
done < "$UIC_CONFFILE" > "$UIC_CONFFILE.tmp"
cat "$UIC_CONFFILE.tmp"
mv "$UIC_CONFFILE.tmp" "$UIC_CONFFILE"

